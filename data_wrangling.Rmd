---
title: "Data Wrangling"
author: "Taryn O'Connor"
date: "11/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringdist)
library(rstanarm)
library(tidymodels)
```

```{r reading data sets, message = FALSE, error = F}
sen_1980 <- read_csv("raw_data/senate_1980.csv")
sen_1982 <- read_csv("raw_data/senate_1982.csv")
sen_1984 <- read_csv("raw_data/senate_1984.csv")
sen_1986 <- read_csv("raw_data/senate_1986.csv")
sen_1988 <- read_csv("raw_data/senate_1988.csv")
sen_1990 <- read_csv("raw_data/senate_1990.csv")
sen_1992 <- read_csv("raw_data/senate_1992.csv")
sen_1994 <- read_csv("raw_data/senate_1994.csv")
sen_1996 <- read_csv("raw_data/senate_1996.csv")
sen_1998 <- read_csv("raw_data/senate_1998.csv")
sen_2000 <- read_csv("raw_data/senate_2000.csv")
sen_2002 <- read_csv("raw_data/senate_2002.csv")
sen_2004 <- read_csv("raw_data/senate_2004.csv")
sen_2006 <- read_csv("raw_data/senate_2006.csv")
sen_2008 <- read_csv("raw_data/senate_2008.csv")
sen_2010 <- read_csv("raw_data/senate_2010.csv")
sen_2012 <- read_csv("raw_data/senate_2012.csv")
sen_2014 <- read_csv("raw_data/senate_2014.csv")
sen_2016 <- read_csv("raw_data/senate_2016.csv")
sen_2018 <- read_csv("raw_data/senate_2018.csv")
sen_2020 <- read_csv("raw_data/senate_2020.csv")
mit_data <- read_csv("raw_data/1976-2018-senate.csv") %>% 
  arrange(desc(year))
```


```{r fec and vote_totals, message = FALSE}
fec <- rbind(sen_1980, sen_1982, 
             sen_1984, sen_1986, sen_1988, 
             sen_1990, sen_1992, sen_1994, 
             sen_1996, sen_1998, sen_2000, 
             sen_2002, sen_2004, sen_2006, 
             sen_2008, sen_2010, sen_2012, 
             sen_2014, sen_2016, sen_2018, sen_2020) %>% 
  select(name, office, party, state, candidate_election_year, incumbent_challenge_full,
         receipts, disbursements, cash_on_hand_end_period, candidate_id) %>% 
  separate(name, into = c("last", "first_middle"), sep = ", ") %>% 
  separate(first_middle, into = c("first", "middle"), sep = " ") %>% 
  unite(full_name, "first", "last", sep = " ") %>% 
  select(-middle) %>% 
  mutate(full_name = tolower(full_name)) %>% 
  mutate(full_name = str_to_title(full_name)) %>% 
  filter(receipts > 0.00) %>% 
  mutate(year = candidate_election_year)

vote_totals <- mit_data %>% 
  filter(year >= 1980) %>% 
  filter(stage == "gen") %>% 
  group_by(year, state_po, special, candidate) %>% 
  mutate(cand_totalvotes = sum(candidatevotes)) %>% 
  mutate(vote_percentage = cand_totalvotes/totalvotes * 100) %>%
  filter(writein == "FALSE") %>% 
  select(year, state, state_po, special, candidate, cand_totalvotes, vote_percentage) %>% 
  unique() %>% 
  filter(vote_percentage >= 10) %>% 
  filter(cand_totalvotes > 100) %>% 
  arrange(desc(year))

```



```{r stringdist function}
name <- function(candidate, year, state_po){
  fec %>% 
    filter(state == state_po) %>% 
    filter(year == year) %>% 
    mutate(distance = map_dbl(full_name, ~ stringdist(., candidate))) %>% 
    slice(which.min(distance)) %>% 
    pull(candidate_id)
}
```

```{r fec_id}
fec_id_vote <- vote_totals %>%
  mutate(candidate_id = pmap_chr(list(candidate = candidate, 
                                candidate_election_year = year, 
                                state_po = state_po),
                           .f = ~ name(candidate = ..1, 
                                       year = ..2, 
                                       state = ..3)))
```

```{r joining}
contribution_votes <- left_join(fec_id_vote, fec, 
                                by = c("candidate_id", "year")) %>% 
  mutate(year = as.character(year)) %>% 
  mutate(party = ifelse(party == "DFL", "DEM", party)) %>% 
  mutate(disbursements = disbursements/1000)
```


```{r model 1}

model_1 <- stan_glm(data = contribution_votes,
         vote_percentage ~ disbursements + year - 1,
         family = gaussian(),
         refresh = 0)

print(model_1, digits = 9)


saveRDS(contribution_votes, "contribution_votes.RDS")

```

```{r model 2}
model_2 <- stan_glm(data = contribution_votes,
         vote_percentage ~ incumbent_challenge_full + year - 1,
         family = gaussian(),
         refresh = 0)

print(model_2, digits = 4)

# year as character value (value for each election)
```

```{r}
votes <- contribution_votes %>% 
  ungroup() %>% 
  select(year, disbursements, vote_percentage) %>% 
  drop_na()
votes_split <- initial_split(votes, prop = .8)
votes_train <- training(votes_split)
votes_test <- training(votes_split)

saveRDS(votes, "votes.RDS")
saveRDS(votes_train, "votes_train.RDS")
saveRDS(votes_test, "votes_test.RDS")



votes <- contribution_votes %>% 
  ungroup() %>% 
  select(year, disbursements, vote_percentage) %>% 
  filter(year == 2012) %>% 
  drop_na()

votes_split <- initial_split(votes, prop = .8)
votes_train <- training(votes_split)
votes_test <- training(votes_split)
votes_folds <- vfold_cv(votes_train, v = 10)

votes_rec <-
  recipe(vote_percentage ~ disbursements, data = votes_train) 

votes_model <- linear_reg() %>% 
  set_engine("lm") %>% 
  set_mode("regression")

votes_wflow <-
  workflow() %>% 
  add_model(votes_model) %>% 
  add_recipe(votes_rec)

votes_metrics <- votes_wflow %>% 
  fit_resamples(resamples = votes_folds) %>% 
  collect_metrics()

votes_wflow %>% 
  fit(data = votes_train) %>% 
  predict(new_data = votes_train) %>% 
  bind_cols(votes_train %>% select(vote_percentage)) %>% 
  ggplot(aes(x = vote_percentage, y = .pred)) +
  geom_point(alpha = .5)
  


  
```

```{r}

votes_wfl <- workflow() %>% 
  add_model(linear_reg() %>%
            set_engine("stan") %>%
            set_mode("regression")) %>% 
  add_recipe(recipe(vote_percentage ~  disbursements,
                    data = votes_train) %>% 
             step_dummy(all_nominal())
             ) 

votes_wfl %>% 
  fit(data = training(initial_split(votes, prop = .8))) %>% 
  predict(new_data = training(initial_split(votes, prop = .8))) %>% 
  bind_cols(votes_train %>% select(vote_percentage)) %>% 
  ggplot(aes(x = vote_percentage, y = .pred)) +
    geom_point()

votes_metrics <- votes_wfl %>% 
  fit_resamples(resamples = votes_folds) %>% 
  collect_metrics()


votes_metrics
```


```{r model p2}
model %>% 
  as_tibble() %>% 
  mutate(receipts_intercept = `(Intercept)` + disbursements) %>% 
  ggplot(aes(x = disbursements, y = after_stat(count/sum(count)))) +
  geom_histogram(bins = 100)

model_2_data <- model_2 %>% 
  as_tibble() %>% 
  add_column(year1980 = 0) %>% 
  mutate(challenger = incumbent_challenge_fullChallenger,
         incumbent = incumbent_challenge_fullIncumbent,
         open_seat = `incumbent_challenge_fullOpen seat`,
         `1980` = year1980,
         `1982` = year1982,
         `1984` = year1984,
         `1986` = year1986,
         `1988` = year1988,
         `1990` = year1990,
         `1992` = year1992,
         `1994` = year1994,
         `1996` = year1996,
         `1998` = year1998,
         `2000` = year2000,
         `2002` = year2002,
         `2004` = year2004,
         `2006` = year2006,
         `2008` = year2008,
         `2010` = year2010,
         `2012` = year2012,
         `2014` = year2014,
         `2016` = year2016,
         `2018` = year2018) %>% 
  pivot_longer(cols = challenger:open_seat,
               names_to = "candidate_status",
               values_to = "percent_vote") %>% 
  mutate(`1980` = `1980` + percent_vote,
         `1982` = `1982` + percent_vote,
         `1984` = `1984` + percent_vote,
         `1986` = `1986` + percent_vote,
         `1988` = `1988` + percent_vote,
         `1990` = `1990` + percent_vote,
         `1992` = `1992` + percent_vote,
         `1994` = `1994` + percent_vote,
         `1996` = `1996` + percent_vote,
         `1998` = `1998` + percent_vote,
         `2000` = `2000` + percent_vote,
         `2002` = `2002` + percent_vote,
         `2004` = `2004` + percent_vote,
         `2006` = `2006` + percent_vote,
         `2008` = `2008` + percent_vote,
         `2010` = `2010` + percent_vote,
         `2012` = `2012` + percent_vote,
         `2014` = `2014` + percent_vote,
         `2016` = `2016` + percent_vote,
         `2018` = `2018` + percent_vote) %>% 
  select(`1980`:percent_vote)
  
saveRDS(model_2_data, "model_2.RDS")


input <- 2012




model_2_data %>% 
  rename(year = as.character(input)) %>% 
  mutate()

model_2_data %>% 
  mutate(year = select(as.character(input)))
  
  
  mutate(total = select(as.character(input), percent_vote) %>% 
           rowSums())

model_2_data %>% 
  rename(year = as.character(input)) %>%
  ggplot(aes(x = year, y = after_stat(count/sum(count)), fill = candidate_status)) +
  geom_histogram(bins = 100,
                 alpha = .5,
                 position = "identity")
```



```{r national partisan difference in spending}
contribution_votes %>% 
  mutate(year = as.numeric(year)) %>% 
  filter(party == "DEM" | party == "REP") %>% 
  ggplot(aes(x = year, y = disbursements/1000000, color = party)) + 
  geom_point(alpha = .3) +
  geom_smooth(alpha = .6) +
  scale_color_manual(values = c("DEM" = "blue", "REP" = "red"), 
                     labels = c("Democrat", "Republican")) +
  labs(title = "Spending on Democratic and Republican Senate Campaigns,
       1980 - 2018",
       x = "Year",
       y = "Spendings (in Millions of Dollars)",
       color = "Party") +
  theme_bw()
```

```{r spending margin for winners (by state)}
win_pre <- contribution_votes %>% 
  group_by(year, state_po, special) %>% 
  mutate(max = max(vote_percentage, na.rm = FALSE)) %>% 
  mutate(win = ifelse(vote_percentage == max, TRUE, FALSE)) 

n_candidates <- win_pre %>% 
  group_by(year, state_po, special) %>% 
  tally()

win <- inner_join(win_pre, n_candidates, by = c("year", "state_po", "special"))

win %>% 
  filter(year == 2000) %>% 
  ggplot(aes(x = disbursements, y = vote_percentage)) +
    geom_point(aes(color = win)) +
    geom_smooth(formula = y ~ x, method = "lm", se = FALSE, alpha = .6, color = "black") +
  scale_color_manual(breaks = c("TRUE", "FALSE"),
                     values = c("TRUE" = "green", "FALSE" = "red"),
                     labels = c("Yes", "No")) +
  theme_bw() +
  labs(title = "Campaign Disbursements and Percentage of Votes",
       subtitle = )

 
```


```{r}
plot_1 <- win %>% 
  filter(n == 2) %>% 
  arrange(year, state_po, special, desc(vote_percentage)) %>% 
  mutate(diff = disbursements[[1]] - disbursements[[2]]) %>% 
  filter(win == "TRUE")

plot_1 %>% 
  filter(state.x == "Massachusetts") %>% 
  ggplot(aes(x = year, y = diff, color = party)) +
  geom_point(size = 5) +
  scale_color_manual(breaks = c("DEM", "REP", "IND"),
                     values = c("DEM" = "darkblue", "REP" = "darkred", "IND" = "darkgreen"), 
                     labels = c("Democrat", "Republican", "Independent")) +
  labs(title = "",
       subtitle = "How much winners outspent their opponents in races with two major contenders",
       x = "Election Year",
       y = "Spending Margin (in Millions of Dollars)",
       color = "Party") +
  scale_x_discrete(breaks = c(1980, 1982, 1984, 1986, 1988, 1990, 
                                          1992, 1994, 1996, 1998, 2000, 2002, 
                                          2004, 2006, 2008, 2010, 2012, 2014, 
                                          2016, 2018)) +
  theme_bw() +
  scale_y_continuous(labels = scales::comma) +
  theme(text = element_text(size = 15), 
        axis.text = element_text(size = 12), 
        axis.title = element_text(size = 20,face = "bold"))

saveRDS(plot_1, "plot_1.RDS")
```


```{r}
model_3_data <- win %>% 
  mutate(year = as.character(year)) %>% 
  filter(n == 2) %>% 
  arrange(year, state_po, special, desc(vote_percentage)) %>% 
  mutate(disbursements = ifelse(candidate == "Albert N. Gore, Jr.", 0, disbursements)) %>%
  mutate(disbursements = ifelse(candidate == "Crystal Young", 0, disbursements)) %>%
  mutate(disbursements = ifelse(candidate == "Shawn O'Hara", 0, disbursements)) %>%
  mutate(disbursements = ifelse(candidate == "Charlie A. Matulka", 0, disbursements)) %>%
  mutate(disbursements = ifelse(candidate == "Guy MacDonald", 0, disbursements)) %>%
  mutate(diff = disbursements[[1]] - disbursements[[2]]) %>% 
  filter(win == TRUE)

# calculate expenditure percentages per candidate

model_3 <- stan_glm(data = model_3_data,
                    vote_percentage ~ diff + year,
                    family = gaussian(),
                    refresh = 0)

print(model_3, digits = 9)

```



```{r}

```

